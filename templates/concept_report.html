<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Concept Report</title>
  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif; color:#0f172a; background:#f8fafc; display:flex; height:100vh; }
    nav { width:320px; background:#fff; border-right:1px solid #e2e8f0; padding:20px; display:flex; flex-direction:column; gap:16px; overflow-y:auto; box-sizing:border-box; }
    nav h1 { font-size:18px; margin:0; }
    .nav-controls { display:flex; flex-direction:column; gap:12px; }
    .filter-buttons { display:flex; gap:8px; }
    .filter-buttons button { flex:1; border:1px solid #cbd5f5; background:#f1f5f9; color:#0f172a; padding:6px 8px; border-radius:8px; font-size:12px; cursor:pointer; }
    .filter-buttons button.active { background:#312e81; color:#fff; border-color:#312e81; }
    .nav-controls label { display:flex; flex-direction:column; gap:4px; font-size:12px; color:#64748b; }
    #concept-filter { padding:6px 8px; border-radius:8px; border:1px solid #cbd5f5; font-size:13px; }
    .study-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    .study-button { width:100%; border:1px solid #e2e8f0; border-radius:12px; background:#fff; display:flex; gap:10px; padding:8px; cursor:pointer; text-align:left; align-items:flex-start; transition:border-color 0.2s, box-shadow 0.2s; }
    .study-button:hover { border-color:#94a3b8; box-shadow:0 2px 6px rgba(15,23,42,0.08); }
    .study-button.active { border-color:#6366f1; box-shadow:0 0 0 2px rgba(99,102,241,0.2); }
    .study-button .thumb { width:64px; height:64px; border-radius:8px; background:#e2e8f0; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0; }
    .study-button .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .study-button .thumb .placeholder { font-size:12px; color:#64748b; text-align:center; padding:8px; }
    .study-button .meta { display:flex; flex-direction:column; gap:4px; flex:1; }
    .study-button .study-id { font-size:14px; font-weight:600; color:#0f172a; }
    .study-button .metric-line { font-size:12px; color:#475569; display:flex; gap:12px; flex-wrap:wrap; }
    .study-button .status-line { font-size:12px; color:#64748b; }
    main { flex:1; display:flex; flex-direction:column; overflow-y:auto; padding:24px 32px; gap:24px; box-sizing:border-box; }
    .global-summary { background:#fff; border-radius:16px; padding:20px 24px; border:1px solid #e2e8f0; box-shadow:0 1px 3px rgba(15,23,42,0.1); }
    .global-summary h2 { margin:0 0 12px 0; font-size:20px; }
    .summary-cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; }
    .summary-card { border:1px solid #e2e8f0; border-radius:12px; padding:12px 14px; background:#fafafa; display:flex; flex-direction:column; gap:6px; }
    .summary-card .label { font-size:12px; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; }
    .summary-card .value { font-size:20px; font-weight:600; color:#111827; }
    .summary-card .sub { font-size:12px; color:#475569; }
    .top-errors { margin-top:16px; }
    .top-errors h3 { margin:0 0 8px 0; font-size:14px; color:#0f172a; }
    .top-errors ul { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; }
    .top-errors li { font-size:12px; color:#475569; display:flex; justify-content:space-between; gap:12px; }
    .top-errors .concept-name { font-weight:600; color:#0f172a; }
    .top-errors .metrics { font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px; color:#334155; }
    .panel-container { display:flex; flex-direction:column; gap:24px; }
    .study-panel { background:#fff; border-radius:16px; border:1px solid #e2e8f0; padding:24px; box-shadow:0 1px 3px rgba(15,23,42,0.08); display:none; flex-direction:column; gap:20px; }
    .study-panel.active { display:flex; }
    .study-panel header { display:flex; flex-direction:column; gap:8px; }
    .study-panel header h2 { margin:0; font-size:20px; color:#0f172a; }
    .dataset-pill { display:inline-block; padding:2px 10px; border-radius:999px; background:#312e81; color:#fff; font-size:12px; text-transform:uppercase; letter-spacing:0.05em; }
    .metric-badges { display:flex; flex-wrap:wrap; gap:8px; font-size:12px; color:#475569; }
    .metric-badges .badge { padding:4px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:600; }
    .metric-badges .badge.error { background:#fee2e2; color:#b91c1c; }
    .metric-badges .badge.neutral { background:#f1f5f9; color:#475569; }
    .image-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px; }
    .image-card { border:1px solid #e2e8f0; border-radius:12px; background:#fff; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 1px 2px rgba(15,23,42,0.06); }
    .image-frame { position:relative; background:#000; display:flex; align-items:center; justify-content:center; height:280px; cursor:zoom-in; }
    .image-frame img { width:100%; height:100%; object-fit:contain; display:block; }
    .image-frame .label { position:absolute; top:8px; left:8px; background:rgba(15,23,42,0.8); color:#fff; padding:2px 8px; border-radius:999px; font-size:11px; }
    .image-frame.missing { background:#f8fafc; padding:16px; color:#64748b; font-size:12px; }
    .image-frame .missing-text { padding:16px; }
    .raw-link { position:absolute; top:8px; right:8px; background:rgba(255,255,255,0.9); border-radius:8px; padding:2px 6px; font-size:12px; color:#1d4ed8; text-decoration:none; border:1px solid rgba(30,64,175,0.3); }
    .raw-link:hover { background:#1d4ed8; color:#fff; }
    .image-card footer { padding:10px 12px; font-size:12px; color:#475569; display:flex; flex-direction:column; gap:4px; background:#fafafa; border-top:1px solid #e2e8f0; }
    .image-card footer .path { font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:11px; color:#64748b; word-break:break-all; }
    .concept-table { border:1px solid #e2e8f0; border-radius:12px; padding:16px; background:#fff; }
    .concept-table h3 { margin:0 0 12px 0; font-size:16px; color:#0f172a; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    thead th { background:#f1f5f9; color:#0f172a; position:sticky; top:0; padding:8px 10px; }
    tbody td { padding:8px 10px; border-bottom:1px solid #e2e8f0; vertical-align:top; }
    tbody tr:last-child td { border-bottom:none; }
    .semantic-chips { display:flex; flex-wrap:wrap; gap:4px; margin-top:6px; }
    .semantic-chip { background:#dbeafe; color:#1e3a8a; font-size:10px; padding:2px 6px; border-radius:999px; text-transform:uppercase; letter-spacing:0.04em; }
    .concept-name-cell { min-width:220px; }
    .concept-name-cell .concept-title { font-weight:600; color:#0f172a; }
    .ontology-context { margin-top:6px; font-size:11px; color:#475569; }
    .ontology-context a { color:#2563eb; text-decoration:none; }
    .ontology-context a:hover { text-decoration:underline; }
    .ontology-tree { margin-top:12px; font-size:12px; color:#475569; border:1px solid #e2e8f0; border-radius:10px; padding:12px 14px; background:#f8fafc; }
    .ontology-tree summary { cursor:pointer; font-weight:600; color:#2563eb; list-style:none; outline:none; }
    .ontology-tree summary::-webkit-details-marker { display:none; }
    .ontology-tree summary::after { content:'▾'; margin-left:6px; font-size:10px; display:inline-block; transition:transform 0.2s ease; }
    .ontology-tree[open] summary::after { transform:rotate(180deg); }
    .ontology-tree .ontology-branch { margin-top:12px; }
    .ontology-tree .ontology-branch:first-of-type { margin-top:8px; }
    .ontology-tree .branch-label { font-weight:600; color:#334155; display:block; margin-bottom:4px; font-size:11px; text-transform:uppercase; letter-spacing:0.04em; }
    .ontology-tree .ontology-node { display:inline-flex; align-items:center; gap:6px; color:#0f172a; font-weight:500; }
    .ontology-tree .ontology-node .ontology-name { font-weight:600; color:#0f172a; }
    .ontology-tree .ontology-node .ontology-cui { font-size:11px; color:#475569; background:#e2e8f0; padding:1px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ontology-tree .ontology-node .ontology-badge { display:inline-block; padding:2px 6px; border-radius:999px; font-size:10px; text-transform:uppercase; letter-spacing:0.04em; }
    .ontology-tree .ontology-node .badge-self { background:#dbeafe; color:#1d4ed8; }
    .ontology-tree .ontology-node .badge-path { background:#ede9fe; color:#5b21b6; }
    .ontology-tree .ontology-node .badge-sibling { background:#fee2e2; color:#b91c1c; }
    .ontology-tree ul { list-style:none; margin:6px 0 0 0; padding-left:16px; display:flex; flex-direction:column; gap:6px; }
    .ontology-tree ul.root-list { margin-top:8px; padding-left:0; }
    .ontology-tree ul.root-list > li::before { display:none; }
    .ontology-tree li { line-height:1.45; position:relative; }
    .ontology-tree li::before { content:''; position:absolute; left:-12px; top:0.6em; width:8px; height:1px; background:#cbd5f5; }
    .ontology-tree a { color:#2563eb; text-decoration:none; }
    .ontology-tree a:hover { text-decoration:underline; }
    .ontology-tree li.ontology-self > .ontology-node .ontology-name { color:#1d4ed8; }
    .ontology-tree li.ontology-path > .ontology-node .ontology-name { color:#1f2937; }
    .ontology-tree li.ontology-sibling > .ontology-node .ontology-name { color:#b91c1c; }
    .synonyms { margin-top:6px; font-size:11px; color:#334155; }
    .status-badge { font-size:12px; padding:3px 8px; border-radius:999px; font-weight:600; display:inline-block; }
    .status-tp { background:#dcfce7; color:#166534; }
    .status-fp { background:#fee2b2; color:#b45309; }
    .status-fn { background:#fecaca; color:#b91c1c; }
    .status-tn { background:#e0e7ff; color:#3730a3; }
    mark.concept-highlight { background:#fef3c7; padding:0 2px; border-radius:4px; }
    mark.concept-highlight.status-tp { background:#d9f99d; }
    mark.concept-highlight.status-fp { background:#fef3c7; }
    mark.concept-highlight.status-fn { background:#fecaca; }
    .report { border:1px solid #e2e8f0; border-radius:12px; padding:16px; background:#f8fafc; }
    .report h3 { margin:0 0 12px 0; font-size:16px; color:#0f172a; }
    .report .report-body { font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:13px; color:#1f2937; white-space:pre-wrap; padding:12px; border:1px solid #e2e8f0; border-radius:8px; background:#fff; }
    .empty { padding:20px; border:1px dashed #cbd5f5; border-radius:12px; background:#fff; color:#64748b; text-align:center; }
    .section-indicators { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
    .section-badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.04em; }
    .section-badge.has-section { background:#dcfce7; color:#166534; }
    .section-badge.no-section { background:#f1f5f9; color:#94a3b8; }
    .image-zoom-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center; cursor:zoom-out; }
    .image-zoom-modal.active { display:flex; }
    .image-zoom-modal img { max-width:95%; max-height:95%; object-fit:contain; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
    .image-zoom-close { position:absolute; top:20px; right:20px; background:#fff; color:#000; border:none; border-radius:50%; width:40px; height:40px; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
    .image-zoom-close:hover { background:#f1f5f9; }
    @media (max-width:1200px) {
      body { flex-direction:column; height:auto; }
      nav { width:100%; max-height:260px; }
      main { padding:20px; }
    }
  </style>
</head>
<body>
{% macro umls_link(node) -%}
  {%- if node.cui %}
    {%- set url = 'https://uts.nlm.nih.gov/uts/umls/concept/' + node.cui %}
    {%- if node.cui.startswith('T') %}
      {%- set url = 'https://uts.nlm.nih.gov/uts/umls/semantic-network/' + node.cui %}
    {%- endif %}
    <a href="{{ url }}" target="_blank" rel="noopener">{{ node.name or node.cui }}</a>
  {%- else %}
    {{ node.name or node.cui }}
  {%- endif -%}
{%- endmacro %}

{% macro render_ontology_node(node) -%}
  {% set css_classes = [] %}
  {% if node.is_self %}
    {% set _ = css_classes.append('ontology-self') %}
  {% elif node.on_path %}
    {% set _ = css_classes.append('ontology-path') %}
  {% else %}
    {% set _ = css_classes.append('ontology-sibling') %}
  {% endif %}
  <li class="ontology-item {{ ' '.join(css_classes) }}">
    <span class="ontology-node">
      <span class="ontology-name">{{ node.name or node.cui }}</span>
      {% if node.cui %}<span class="ontology-cui">{{ node.cui }}</span>{% endif %}
      {% if node.is_self %}
        <span class="ontology-badge badge-self">You are here</span>
      {% elif node.on_path %}
        <span class="ontology-badge badge-path">Path</span>
      {% else %}
        <span class="ontology-badge badge-sibling">Sibling</span>
      {% endif %}
    </span>
    {% if node.children %}
    <ul class="ontology-list">
      {% for child in node.children %}
        {{ render_ontology_node(child) }}
      {% endfor %}
    </ul>
    {% endif %}
  </li>
{%- endmacro %}
  <nav>
    <h1>Studies</h1>
    <div class="nav-controls">
      <div class="filter-buttons">
        <button type="button" id="filter-reset" class="active">All</button>
        <button type="button" id="filter-low-f1">F1 &lt; {{ filters.low_f1_threshold }}</button>
      </div>
      <label for="concept-filter">
        <span>Concept filter</span>
        <input id="concept-filter" type="text" placeholder="Find concept (name or CUI)">
      </label>
    </div>
    <ul class="study-list">
      {% for study in studies %}
      <li>
        <button type="button" class="study-button" data-target="panel-{{ loop.index0 }}" data-f1="{{ study.metrics.f1 }}" data-concepts="{{ study.concept_terms }}">
          <div class="thumb">
            {% if study.nav_thumb %}
              <img src="data:image/png;base64,{{ study.nav_thumb }}" alt="thumbnail for {{ study.study }}">
            {% else %}
              <span class="placeholder">No image</span>
            {% endif %}
          </div>
          <div class="meta">
            <div class="study-id">{{ study.study }}</div>
            <div class="metric-line">F1 {{ study.metrics_display.f1 }} · Precision {{ study.metrics_display.precision }} · Recall {{ study.metrics_display.recall }}</div>
            <div class="status-line">TP {{ study.counts.tp }} · FP {{ study.counts.fp }} · FN {{ study.counts.fn }}</div>
          </div>
        </button>
      </li>
      {% endfor %}
    </ul>
  </nav>
  <main>
    <section class="global-summary">
      <h2>Evaluation overview</h2>
      <div class="summary-cards">
        <div class="summary-card">
          <div class="label">Total studies</div>
          <div class="value">{{ summary.total_studies }}</div>
          <div class="sub">Low overlap (&lt;{{ filters.low_f1_threshold }} F1): {{ summary.low_overlap }}</div>
        </div>
        <div class="summary-card">
          <div class="label">Mean F1</div>
          <div class="value">{{ summary_display.mean_f1 }}</div>
          <div class="sub">Precision {{ summary_display.mean_precision }} · Recall {{ summary_display.mean_recall }}</div>
        </div>
        <div class="summary-card">
          <div class="label">Micro totals</div>
          <div class="value">{{ summary.totals.tp }} / {{ summary.totals.fp }} / {{ summary.totals.fn }}</div>
          <div class="sub">TP / FP / FN</div>
        </div>
        <div class="summary-card">
          <div class="label">Mean concepts</div>
          <div class="value">{{ summary_display.mean_ref_count }} ref</div>
          <div class="sub">Pred {{ summary_display.mean_pred_count }}</div>
        </div>
      </div>
      {% if top_errors %}
      <div class="top-errors">
        <h3>Top concepts by error rate</h3>
        <ul>
          {% for row in top_errors %}
          <li>
            <span class="concept-name">{{ row.name or "—" }}</span>
            <span class="metrics">err {{ row.error_rate_display }} · FP {{ row.fp }} · FN {{ row.fn }} · TP {{ row.tp }} · {{ row.cui or "—" }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </section>
    <div class="panel-container">
      {% for study in studies %}
      <div class="study-panel" id="panel-{{ loop.index0 }}">
        <header>
          <h2>{{ study.study }}</h2>
          {% if study.dataset %}
          <span class="dataset-pill">{{ study.dataset }}</span>
          {% endif %}
          <div class="metric-badges">
            <span class="badge">F1 {{ study.metrics_display.f1 }}</span>
            <span class="badge">Precision {{ study.metrics_display.precision }}</span>
            <span class="badge">Recall {{ study.metrics_display.recall }}</span>
            <span class="badge neutral">TP {{ study.counts.tp }}</span>
            {% if study.counts.fp %}
            <span class="badge error">FP {{ study.counts.fp }}</span>
            {% endif %}
            {% if study.counts.fn %}
            <span class="badge error">FN {{ study.counts.fn }}</span>
            {% endif %}
          </div>
        </header>
        {% if study.images %}
        <div class="image-grid">
          {% for image in study.images %}
          <div class="image-card">
            <div class="image-frame{% if not image.base_b64 %} missing{% endif %}">
              {% if image.base_b64 %}
              <img src="data:image/png;base64,{{ image.base_b64 }}" alt="{{ image.filename }} base image">
              {% if image.raw_href %}
              <a class="raw-link" href="{{ image.raw_href }}" target="_blank" rel="noopener">file</a>
              {% endif %}
              {% else %}
              <span class="missing-text">Image unavailable</span>
              {% endif %}
            </div>
            {% if image.cam_b64 %}
            <div class="image-frame">
              <img src="data:image/png;base64,{{ image.cam_b64 }}" alt="{{ image.filename }} grad-cam">
              <span class="label">Grad-CAM</span>
            </div>
            {% endif %}
            <footer>
              <div>{{ image.filename }}</div>
              <div class="path">{{ image.raw_display }}</div>
            </footer>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty">No image available</div>
        {% endif %}
        {% if study.has_report %}
        <section class="report">
          <h3>Report Text</h3>
          <div class="section-indicators">
            <span class="section-badge {% if study.has_impression %}has-section{% else %}no-section{% endif %}">
              {% if study.has_impression %}✓ {% endif %}Impression
            </span>
            <span class="section-badge {% if study.has_findings %}has-section{% else %}no-section{% endif %}">
              {% if study.has_findings %}✓ {% endif %}Findings
            </span>
          </div>
          <div class="report-body">{{ study.report_html | safe }}</div>
        </section>
        {% else %}
        <section class="report">
          <h3>Report Text</h3>
          <div class="empty">No report available</div>
        </section>
        {% endif %}
        <section class="concept-table">
          <h3>Concept Diff</h3>
          <table>
            <thead>
              <tr><th>Status</th><th>CUI</th><th>Concept &amp; Context</th><th>Pred Score</th><th>Evidence</th></tr>
            </thead>
            <tbody>
              {% if study.concept_rows %}
                {% for row in study.concept_rows %}
                <tr>
                  <td><span class="status-badge {{ row.status_class }}">{{ row.status }}</span></td>
                  <td>
                    {% if row.cui and row.cui != '—' %}
                      {{ umls_link({'cui': row.cui, 'name': row.cui}) }}
                    {% else %}
                      {{ row.cui }}
                    {% endif %}
                  </td>
                  <td class="concept-name-cell">
                    <div class="concept-title">{{ row.name }}</div>
                    {% if row.semantic_types %}
                    <div class="semantic-chips">
                      {% for st in row.semantic_types %}
                      <span class="semantic-chip">{{ st }}</span>
                      {% endfor %}
                    </div>
                    {% endif %}
                    {% if row.synonyms_display and row.synonyms_display != "—" %}
                    <div class="synonyms">Synonyms: {{ row.synonyms_display }}</div>
                    {% endif %}
                    {% if row.has_ontology %}
                    {% if row.breadcrumbs %}
                    <div class="ontology-context">
                      {% for path in row.breadcrumbs %}
                        {% for node in path %}
                          {{ node.name or node.cui }}{% if not loop.last %} → {% endif %}
                        {% endfor %}
                        {% if not loop.last %}<br>{% endif %}
                      {% endfor %}
                    </div>
                    {% endif %}
                    <details class="ontology-tree">
                      <summary>Ontology neighborhood</summary>
                      <ul class="ontology-list root-list">
                        {% for root in row.ontology_tree %}
                          {{ render_ontology_node(root) }}
                        {% endfor %}
                      </ul>
                    </details>
                    {% endif %}
                  </td>
                  <td>{{ row.pred_score_display }}</td>
                  <td>{{ row.evidence_display }}</td>
                </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="5">No concepts</td></tr>
              {% endif %}
            </tbody>
          </table>
        </section>
      </div>
      {% endfor %}
    </div>
  </main>
  <script>
    const navButtons = Array.from(document.querySelectorAll('nav button.study-button'));
    const panels = Array.from(document.querySelectorAll('.study-panel'));
    function activateButton(button) {
      navButtons.forEach(b => b.classList.remove('active'));
      panels.forEach(panel => panel.classList.remove('active'));
      if (!button) { return; }
      button.classList.add('active');
      const panelId = button.dataset.target;
      const panel = document.getElementById(panelId);
      if (panel) { panel.classList.add('active'); }
    }
    navButtons.forEach(button => {
      button.addEventListener('click', () => { activateButton(button); });
    });
    const conceptFilter = document.getElementById('concept-filter');
    const lowFilterButton = document.getElementById('filter-low-f1');
    const resetFilterButton = document.getElementById('filter-reset');
    function applyFilters() {
      const query = (conceptFilter.value || '').trim().toLowerCase();
      const lowOnly = lowFilterButton.classList.contains('active');
      let firstVisible = null;
      navButtons.forEach(button => {
        const item = button.closest('li');
        let visible = true;
        const f1 = parseFloat(button.dataset.f1 || '0');
        if (lowOnly && !(f1 < {{ filters.low_f1_threshold }})) { visible = false; }
        if (visible && query) {
          const concepts = (button.dataset.concepts || '').toLowerCase();
          visible = concepts.includes(query);
        }
        if (item) { item.style.display = visible ? '' : 'none'; }
        if (visible && !firstVisible) { firstVisible = button; }
      });
      const activeButton = document.querySelector('nav button.study-button.active');
      if (!activeButton || (activeButton.closest('li') && activeButton.closest('li').style.display === 'none')) {
        if (firstVisible) { activateButton(firstVisible); } else { panels.forEach(panel => panel.classList.remove('active')); }
      }
    }
    conceptFilter.addEventListener('input', () => { applyFilters(); });
    lowFilterButton.addEventListener('click', () => {
      lowFilterButton.classList.toggle('active');
      if (lowFilterButton.classList.contains('active')) { resetFilterButton.classList.remove('active'); }
      applyFilters();
    });
    resetFilterButton.addEventListener('click', () => {
      lowFilterButton.classList.remove('active');
      resetFilterButton.classList.add('active');
      conceptFilter.value = '';
      applyFilters();
    });
    if (navButtons.length) {
      activateButton(navButtons[0]);
    }
    applyFilters();

    // Image zoom functionality
    const modal = document.createElement('div');
    modal.className = 'image-zoom-modal';
    modal.innerHTML = '<button class="image-zoom-close" aria-label="Close">&times;</button><img src="" alt="Zoomed image">';
    document.body.appendChild(modal);

    const modalImg = modal.querySelector('img');
    const closeBtn = modal.querySelector('.image-zoom-close');

    function openImageZoom(imageSrc) {
      modalImg.src = imageSrc;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeImageZoom() {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }

    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target === closeBtn) {
        closeImageZoom();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeImageZoom();
      }
    });

    // Add click handlers to all images
    document.querySelectorAll('.image-frame img').forEach(img => {
      img.addEventListener('click', (e) => {
        e.stopPropagation();
        openImageZoom(img.src);
      });
    });
  </script>
</body>
</html>
